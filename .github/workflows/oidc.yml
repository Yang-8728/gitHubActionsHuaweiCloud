name: List HuaweiCloud VPCs via OIDC
on: [workflow_dispatch]

permissions:
  id-token: write
  contents: read

jobs:
  list-vpc:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get OIDC token and list VPCs
        env:
          HW_REGION:     ${{ secrets.HW_REGION }}        # ä¾‹: ap-southeast-2
          HW_PROJECT_ID: ${{ secrets.HW_PROJECT_ID }}    # ä½ çš„é¡¹ç›®ID
          HW_AUDIENCE:   ${{ secrets.HW_AUDIENCE }}      # ä¸ŽIdP Client IDä¸€è‡´, é€šå¸¸ sts.huaweicloud.com
          HW_IDP_NAME:   ${{ secrets.HW_IDP_NAME }}      # ä¾‹: github-actions
        shell: bash
        run: |
          set -euo pipefail

          echo "ðŸ”¹ Step 1. Request GitHub OIDC ID token"
          ID_TOKEN="$(
            curl -sSf -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
              "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=${HW_AUDIENCE}" \
            | python -c 'import sys,json; print(json.load(sys.stdin)["value"])'
          )"
          echo "âœ… Got ID token (len: ${#ID_TOKEN})"

          echo "ðŸ”¹ Step 2. Exchange for federated token"
          endpoint="https://iam.${HW_REGION}.myhuaweicloud.com"
          body=$(cat <<JSON
{
  "auth": {
    "identity": {
      "methods": ["oidc"],
      "oidc": { "id_token": "${ID_TOKEN}" },
      "provider": { "name": "${HW_IDP_NAME}" },
      "protocol": { "name": "oidc" }
    },
    "scope": { "project": { "id": "${HW_PROJECT_ID}" } }
  }
}
JSON
)
          http=$(curl -s -D headers.txt -o body.txt -w "%{http_code}" \
            -H "Content-Type: application/json" -X POST \
            "$endpoint/v3/OS-FEDERATION/tokens" -d "$body")
          test "$http" -lt 400 || { echo "âŒ Exchange failed: $http"; cat body.txt; exit 1; }
          XST=$(grep -i '^X-Subject-Token:' headers.txt | awk '{print $2}' | tr -d '\r')
          echo "âœ… Got federated token (XST length: ${#XST})"

          echo "ðŸ”¹ Step 3. List VPCs"
          curl -s -H "X-Auth-Token: $XST" \
            "https://vpc.${HW_REGION}.myhuaweicloud.com/v1/${HW_PROJECT_ID}/vpcs" \
          | python -c 'import sys,json; d=json.load(sys.stdin); v=d.get("vpcs",[]); print("âœ… VPC count:",len(v)); [print(" -",x.get("name")) for x in v]'
