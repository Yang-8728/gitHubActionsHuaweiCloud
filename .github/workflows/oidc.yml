name: huawei-oidc-list-vpc
on: [workflow_dispatch]

permissions:
  id-token: write
  contents: read

jobs:
  list-vpc:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: List VPCs via OIDC (Huawei Cloud Global IAM)
        shell: bash
        env:
          HW_REGION:     ${{ secrets.HW_REGION }}       # 例如 ap-southeast-2
          HW_PROJECT_ID: ${{ secrets.HW_PROJECT_ID }}   # 项目ID
          HW_AUDIENCE:   ${{ secrets.HW_AUDIENCE }}     # 与 IdP 的 Client ID 一致，通常 sts.huaweicloud.com
          HW_IDP_NAME:   ${{ secrets.HW_IDP_NAME }}     # 例如 github-actions
        run: |
          set -euo pipefail

          echo "[DEBUG] REGION=$HW_REGION  PROJECT_ID=$HW_PROJECT_ID  IDP=$HW_IDP_NAME  AUD=$HW_AUDIENCE"

          echo "[1/3] Request GitHub OIDC ID token"
          ID_TOKEN="$(
            curl -sSf -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
              "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=${HW_AUDIENCE}" \
            | python -c 'import sys,json; print(json.load(sys.stdin)["value"])'
          )"
          echo "[1/3] OK. id_token length=${#ID_TOKEN}"

          echo "[2/3] Exchange federated token via Huawei Cloud Global IAM"
          endpoint="https://iam.myhuaweicloud.com"
          body='{"auth":{"identity":{"methods":["oidc"],"oidc":{"id_token":"'"$ID_TOKEN"'"},"provider":{"name":"'"$HW_IDP_NAME"'"},"protocol":{"name":"oidc"}},"scope":{"project":{"id":"'"$HW_PROJECT_ID"'"}}}}'

          try_exchange () {
            local base="$1"
            local path="$2"
            echo "    -> $base$path"
            http=$(curl -sS -D headers.txt -o body.txt -w "%{http_code}" \
              -H 'Content-Type: application/json' \
              -H "X-Idp-Id: ${HW_IDP_NAME}" \
              -H "X-Protocol-Id: oidc" \
              -X POST "$base$path" -d "$body" || true)
            echo "    <- HTTP $http"
            XST=$(grep -i '^X-Subject-Token:' headers.txt | awk '{print $2}' | tr -d '\r' || true)
          }

          # 仅使用全局 IAM 端点 (国际站)
          try_exchange "$endpoint" "/v3/OS-FEDERATION/tokens"
          if [ -z "${XST:-}" ] || [ "${http:-999}" -ge 400 ]; then
            try_exchange "$endpoint" "/v3.0/OS-FEDERATION/tokens"
          fi

          if [ -z "${XST:-}" ]; then
            echo "❌ Failed to exchange federated token."
            echo "---- Response headers ----"; cat headers.txt || true
            echo "---- Response body ----"; cat body.txt || true
            exit 1
          fi
          echo "[2/3] OK. X-Subject-Token length=${#XST}"

          echo "[3/3] List VPCs"
          curl -sS -H "X-Auth-Token: $XST" \
            "https://vpc.${HW_REGION}.myhuaweicloud.com/v1/${HW_PROJECT_ID}/vpcs" \
          | python -c 'import sys,json; d=json.load(sys.stdin); v=d.get("vpcs",[]); print("✅ VPC count:",len(v)); [print("-",x.get("name")) for x in v]'
