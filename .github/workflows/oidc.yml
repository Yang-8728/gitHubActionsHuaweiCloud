name: huawei-oidc-list-vpc
on: [workflow_dispatch]

permissions:
  id-token: write
  contents: read

jobs:
  list-vpc:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: List VPCs via OIDC
        shell: bash
        env:
          HW_REGION:     ${{ secrets.HW_REGION }}       # 例如 ap-southeast-2
          HW_PROJECT_ID: ${{ secrets.HW_PROJECT_ID }}   # 项目ID
          HW_AUDIENCE:   ${{ secrets.HW_AUDIENCE }}     # 与 IdP 的 Client ID 一致，通常 sts.huaweicloud.com
          HW_IDP_NAME:   ${{ secrets.HW_IDP_NAME }}     # 例如 github-actions
        run: |
          set -euo pipefail

          # 1) 向 GitHub 申请 OIDC ID token
          ID_TOKEN=$(
            curl -sSf -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
              "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=${HW_AUDIENCE}" \
            | python -c 'import sys,json; print(json.load(sys.stdin)["value"])'
          )

          # 2) 用 ID token 向华为云换取联邦 Token (X-Subject-Token)
          endpoint="https://iam.${HW_REGION}.myhuaweicloud.com"
          body='{"auth":{"identity":{"methods":["oidc"],"oidc":{"id_token":"'"$ID_TOKEN"'"},"provider":{"name":"'"$HW_IDP_NAME"'"},"protocol":{"name":"oidc"}},"scope":{"project":{"id":"'"$HW_PROJECT_ID"'"}}}}'

          # 先试 v3，失败则试 v3.0（不同区域网关版本可能不同）
          curl -s -D headers.txt -o body.txt -H 'Content-Type: application/json' \
            -X POST "$endpoint/v3/OS-FEDERATION/tokens" -d "$body" > /dev/null || true
          XST=$(grep -i '^X-Subject-Token:' headers.txt | awk '{print $2}' | tr -d '\r')
          if [ -z "$XST" ]; then
            curl -s -D headers.txt -o body.txt -H 'Content-Type: application/json' \
              -X POST "$endpoint/v3.0/OS-FEDERATION/tokens" -d "$body" > /dev/null
            XST=$(grep -i '^X-Subject-Token:' headers.txt | awk '{print $2}' | tr -d '\r')
          fi
          test -n "$XST" || { echo "Failed to get federated token"; cat body.txt; exit 1; }

          # 3) 列出 VPC 名称
          curl -s -H "X-Auth-Token: $XST" \
            "https://vpc.${HW_REGION}.myhuaweicloud.com/v1/${HW_PROJECT_ID}/vpcs" \
          | python -c 'import sys,json; d=json.load(sys.stdin); v=d.get("vpcs",[]); print("VPC count:", len(v)); [print("-", x.get("name")) for x in v]'
